<% product = local_assigns.fetch(:product) %>
<% thumb = product.images.attached? ? product.images.first.variant(resize_to_limit: [1200, 1200]) : nil %>

<div id="<%= dom_id(product, :detail) %>" class="w-full">
  <div class="flex flex-col md:flex-row md:gap-6 w-full">
    <div class="w-full md:w-1/2">
      <% if product.images.attached? %>
        <div class="md:flex md:gap-4">
          <!-- Thumbnails (vertical on md+, hidden on mobile) -->
          <div class="hidden md:flex md:flex-col md:gap-2 md:w-20">
            <% product.images.each do |img| %>
              <%= image_tag img.variant(resize_to_limit: [100, 100]),
                    data: { full: url_for(img.variant(resize_to_limit: [1200, 1200])) },
                    class: "js-thumb rounded-md w-20 h-20 object-cover border border-gray-200 cursor-pointer hover:opacity-80" %>
            <% end %>
          </div>

          <!-- Main image -->
          <div class="flex-1">
            <%= image_tag product.images.first.variant(resize_to_limit: [1200, 1200]),
                  id: dom_id(product, :main_image),
                  class: "w-full object-cover rounded-lg" %>
          </div>
        </div>

        <!-- Thumbnails row (mobile) -->
        <div class="flex md:hidden gap-2 mt-3">
          <% product.images.each do |img| %>
            <%= image_tag img.variant(resize_to_limit: [80, 80]),
                  data: { full: url_for(img.variant(resize_to_limit: [1200, 1200])) },
                  class: "js-thumb rounded-md w-20 h-20 object-cover border border-gray-200 cursor-pointer hover:opacity-80" %>
          <% end %>
        </div>
      <% else %>
        <%= image_tag "placeholder.png", class: "w-full rounded-lg object-cover" %>
      <% end %>
    </div>

    <div class="w-full md:w-1/2 flex flex-col">
      <h1 class="text-2xl font-bold text-gray-900"><%= product.title %></h1>

      <div class="mt-2 flex items-center justify-between">
        <span class="text-3xl font-bold text-gray-900">Â¥<%= number_to_currency(product.price, unit: "", precision: 0) %></span>
          <%= form_with url: cart_item_create_path(product), method: :post, local: true, class: "flex items-center gap-2" do |f| %>
            <%= number_field_tag "cart_item[quantity]", 1, min: 1,
                class: "w-20 border rounded p-1 text-sm" %>
            <%= f.submit "Add to cart",
                class: "text-white bg-blue-600 hover:bg-blue-500 rounded-lg text-sm px-5 py-2.5 font-medium" %>
          <% end %>
      </div>

      <%= turbo_frame_tag dom_id(product, :favorite_button) do %>
        <%= render "favorites/button", product: product %>
      <% end %>

      <%# Full description, meta, etc. %>
      <p class="mt-3 text-gray-700 leading-7"><%= product.description %></p>

      <div class="mt-2">
        <span class="inline-block rounded px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600">
          <%= product.status %>
        </span>
      </div>

      
    </div>
  </div>

  <script>
    (function() {
      const root = document.getElementById("<%= dom_id(product, :detail) %>");
      if (!root) return;

      const main = root.querySelector("#<%= dom_id(product, :main_image) %>");
      if (!main) return;

      const thumbs = root.querySelectorAll(".js-thumb");

      function clearActive() {
        thumbs.forEach(t => t.classList.remove("ring-2", "ring-blue-500"));
      }

      thumbs.forEach(thumb => {
        thumb.addEventListener("click", () => {
          const full = thumb.dataset.full;
          if (full) {
            main.src = full;
            clearActive();
            thumb.classList.add("ring-2", "ring-blue-500");
          }
        });
      });
    })();
  </script>
</div>
